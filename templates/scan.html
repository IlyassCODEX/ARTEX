{% extends "base.html" %}

{% block title %}Scan | ARTEX{% endblock %}

{% block content %}
<div class="container d-flex flex-column" style="min-height: 80vh;">
    <div class="row my-auto">
        <div class="col-lg-6 mx-auto">
            <div class="text-center mb-4">
                <h3 class="fw-bold mb-2">ARTEX Security Scan</h3>
                <p class="text-muted small">Discover subdomains, analyze security risks and AI dual-perspective insights</p>
            </div>
            
            <div class="card-retro p-3">
                <div class="card-body">
                    <form id="scanForm">
                        <div class="mb-3">
                            <label for="domainInput" class="form-label small text-muted">TARGET DOMAIN</label>
                            <input type="text" class="form-control form-control-lg mb-3" id="domainInput" placeholder="example.com" required 
                                   style="border: 2px solid #000; font-family: 'Courier New', monospace;">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small text-muted">SCAN OPTIONS</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input-retro" type="checkbox" id="subdomainsCheck" checked>
                                <label class="form-check-label" for="subdomainsCheck">
                                    Subdomain Enumeration
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input-retro" type="checkbox" id="portsCheck" checked>
                                <label class="form-check-label" for="portsCheck">
                                    Port Scanning
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input-retro" type="checkbox" id="techCheck" checked>
                                <label class="form-check-label" for="techCheck">
                                    Technology Detection
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input-retro" type="checkbox" id="emailCheck" checked>
                                <label class="form-check-label" for="emailCheck">
                                    Email Enumeration
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input-retro" type="checkbox" id="securityCheck" checked disabled>
                                <label class="form-check-label" for="securityCheck">
                                    Security Analysis (Always included)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input-retro" type="checkbox" id="aiCheck" checked disabled>
                                <label class="form-check-label" for="aiCheck">
                                    AI Analysis (Always included)
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-retro btn-retro-primary w-100 py-2" id="scanButton">
                            <i class="bi bi-search"></i> Start Scan
                        </button>
                    </form>
                    
                    <div id="scanProgress" class="mt-4" style="display: none;">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span id="currentTask">Initializing...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress" style="height: 8px; border: 2px solid #000;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%; background-color: #4a6baf;"></div>
                        </div>
                        
                        <div id="resultsSection" class="mt-3 text-center" style="display: none;">
                            <div class="alert alert-success small py-2 mb-2" style="border: 2px solid #000; background-color: #d4edda;">
                                <i class="bi bi-check-circle"></i> Scan completed
                            </div>
                            <a href="#" id="viewResultsBtn" class="btn btn-retro btn-retro-primary">
                                View Results
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3 text-center small text-muted">
                <div>Scan ID: <span id="scanIdDisplay">-</span></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentScanId = null;
    let statusCheckInterval = null;
    
    $('#scanForm').submit(function(e) {
        e.preventDefault();
        const domain = $('#domainInput').val().trim();
        if (!domain) return;
        
        const scanOptions = {
            subdomains: $('#subdomainsCheck').is(':checked'),
            ports: $('#portsCheck').is(':checked'),
            tech: $('#techCheck').is(':checked'),
            email: $('#emailCheck').is(':checked'),
            // security and ai are always true
            security: true,
            ai: true
        };
        
        $('#scanButton').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Scanning...');
        $('#scanProgress').show();
        
        $.ajax({
            url: '/start_scan',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                domain: domain,
                options: scanOptions 
            }),
            success: function(response) {
                currentScanId = response.scan_id;
                $('#scanIdDisplay').text(currentScanId);
                statusCheckInterval = setInterval(checkScanStatus, 2000);
            },
            error: function(xhr) {
                $('#scanButton').html('<i class="bi bi-search"></i> Start Scan').prop('disabled', false);
                $('#scanProgress').append(
                    '<div class="alert alert-danger mt-3 small py-2" style="border: 2px solid #000; background-color: #f8d7da;">' +
                    '<i class="bi bi-exclamation-triangle"></i> ' + (xhr.responseJSON?.error || 'Error starting scan') +
                    '</div>'
                );
            }
        });
    });
    
    function checkScanStatus() {
        if (!currentScanId) return;
        
        $.get('/scan_status/' + currentScanId)
            .done(function(status) {
                $('#progressBar').css('width', status.progress + '%');
                $('#progressPercent').text(status.progress + '%');
                $('#currentTask').text(status.current_task);
                
                if (status.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    $('#progressBar').removeClass('progress-bar-animated progress-bar-striped');
                    $('#resultsSection').show();
                    $('#viewResultsBtn').attr('href', '/results/' + currentScanId);
                    $('#scanButton').html('<i class="bi bi-search"></i> New Scan').prop('disabled', false);
                } else if (status.status === 'error') {
                    clearInterval(statusCheckInterval);
                    $('#scanProgress').append(
                        '<div class="alert alert-danger mt-3 small py-2" style="border: 2px solid #000; background-color: #f8d7da;">' +
                        '<i class="bi bi-exclamation-triangle"></i> ' + status.error +
                        '</div>'
                    );
                    $('#scanButton').html('<i class="bi bi-search"></i> Try Again').prop('disabled', false);
                }
            })
            .fail(function() {
                clearInterval(statusCheckInterval);
                $('#scanProgress').append(
                    '<div class="alert alert-danger mt-3 small py-2" style="border: 2px solid #000; background-color: #f8d7da;">' +
                    '<i class="bi bi-exclamation-triangle"></i> Connection error' +
                    '</div>'
                );
                $('#scanButton').html('<i class="bi bi-search"></i> Try Again').prop('disabled', false);
            });
    }
});
</script>
{% endblock %}