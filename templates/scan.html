{% extends "base.html" %}

{% block title %}Scan | ARTEX{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card card-modern border-0 mb-4">
                <div class="card-body p-5">
                    <div class="text-center mb-5">
                        <h2 class="fw-bold mb-3">Security Scan</h2>
                        <p class="text-muted">Discover subdomains, analyze security risks and get AI-powered insights</p>
                    </div>
                    
                    <form id="scanForm">
                        <div class="mb-4">
                            <label for="domainInput" class="form-label fw-medium">Target Domain</label>
                            <input type="text" class="form-control form-control-modern" id="domainInput" 
                                   placeholder="example.com" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-medium">Scan Options</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check p-3 bg-light rounded">
                                        <input class="form-check-input" type="checkbox" id="subdomainsCheck" checked>
                                        <label class="form-check-label fw-medium" for="subdomainsCheck">
                                            Subdomain Enumeration
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check p-3 bg-light rounded">
                                        <input class="form-check-input" type="checkbox" id="portsCheck" checked>
                                        <label class="form-check-label fw-medium" for="portsCheck">
                                            Port Scanning
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check p-3 bg-light rounded">
                                        <input class="form-check-input" type="checkbox" id="dnsCheck" checked>
                                        <label class="form-check-label fw-medium" for="dnsCheck">
                                            DNS Records
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check p-3 bg-light rounded">
                                        <input class="form-check-input" type="checkbox" id="techCheck" checked>
                                        <label class="form-check-label fw-medium" for="techCheck">
                                            Technology Detection
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check p-3 bg-light rounded">
                                        <input class="form-check-input" type="checkbox" id="emailCheck" checked>
                                        <label class="form-check-label fw-medium" for="emailCheck">
                                            Email Enumeration
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-modern" id="scanButton">
                                <i class="bi bi-search me-2"></i> Start Scan
                            </button>
                        </div>
                    </form>
                    
                    <div id="scanProgress" class="mt-5" style="display: none;">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-medium" id="currentTask">Initializing scan...</span>
                            <span class="text-primary fw-medium" id="progressPercent">0%</span>
                        </div>
                        <div class="progress progress-modern mb-4">
                            <div id="progressBar" class="progress-bar progress-bar-modern progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <div id="resultsSection" class="text-center" style="display: none;">
                            <div class="alert alert-success alert-modern mb-4">
                                <i class="bi bi-check-circle-fill me-2"></i> Scan completed successfully
                            </div>
                            <a href="#" id="viewResultsBtn" class="btn btn-modern">
                                <i class="bi bi-file-earmark-text me-2"></i> View Results
                            </a>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center text-muted small">
                        <div>Scan ID: <span id="scanIdDisplay" class="fw-medium">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentScanId = null;
    let statusCheckInterval = null;
    
    $('#scanForm').submit(function(e) {
        e.preventDefault();
        const domain = $('#domainInput').val().trim();
        if (!domain) return;
        
        const scanOptions = {
            subdomains: $('#subdomainsCheck').is(':checked'),
            ports: $('#portsCheck').is(':checked'),
            dns: $('#dnsCheck').is(':checked'),
            tech: $('#techCheck').is(':checked'),
            email: $('#emailCheck').is(':checked'),
            security: true,
            ai: true
        };
        
        $('#scanButton').prop('disabled', true).html('<i class="bi bi-hourglass me-2"></i> Scanning...');
        $('#scanProgress').show();
        
        $.ajax({
            url: '/start_scan',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                domain: domain,
                options: scanOptions 
            }),
            success: function(response) {
                currentScanId = response.scan_id;
                $('#scanIdDisplay').text(currentScanId);
                statusCheckInterval = setInterval(checkScanStatus, 2000);
            },
            error: function(xhr) {
                $('#scanButton').html('<i class="bi bi-search me-2"></i> Start Scan').prop('disabled', false);
                $('#scanProgress').append(
                    '<div class="alert alert-danger alert-modern mt-4">' +
                    '<i class="bi bi-exclamation-triangle-fill me-2"></i>' + 
                    (xhr.responseJSON?.error || 'Error starting scan') +
                    '</div>'
                );
            }
        });
    });
    
    function checkScanStatus() {
        if (!currentScanId) return;
        
        $.get('/scan_status/' + currentScanId)
            .done(function(status) {
                $('#progressBar').css('width', status.progress + '%');
                $('#progressPercent').text(status.progress + '%');
                $('#currentTask').text(status.current_task);
                
                if (status.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    $('#progressBar').removeClass('progress-bar-animated progress-bar-striped');
                    $('#resultsSection').show();
                    $('#viewResultsBtn').attr('href', '/results/' + currentScanId);
                    $('#scanButton').html('<i class="bi bi-search me-2"></i> New Scan').prop('disabled', false);
                } else if (status.status === 'error') {
                    clearInterval(statusCheckInterval);
                    $('#scanProgress').append(
                        '<div class="alert alert-danger alert-modern mt-4">' +
                        '<i class="bi bi-exclamation-triangle-fill me-2"></i>' + status.error +
                        '</div>'
                    );
                    $('#scanButton').html('<i class="bi bi-search me-2"></i> Try Again').prop('disabled', false);
                }
            })
            .fail(function() {
                clearInterval(statusCheckInterval);
                $('#scanProgress').append(
                    '<div class="alert alert-danger alert-modern mt-4">' +
                    '<i class="bi bi-exclamation-triangle-fill me-2"></i> Connection error' +
                    '</div>'
                );
                $('#scanButton').html('<i class="bi bi-search me-2"></i> Try Again').prop('disabled', false);
            });
    }
});
</script>
{% endblock %}
